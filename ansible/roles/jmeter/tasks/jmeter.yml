---
- name: Install jmeter
  apt:
    pkg: jmeter
  become: yes

- name: Create temporary directory
  shell: mktemp -d
  register: tempdir
  become: true
  tags: jmeter_setup

#jmeter plugins standard
# - name: jmeter | Download jmeter plugins standard
#   get_url:
#     url="{{ jmeter_plugins_standard_url }}"
#     dest="{{ jmeter_dir_tmp }}/"
#   register: jmeter_plugins_standard_download
#   when: jmeter_plugins_standard_enabled
#   tags: jmeter_setup

# - name: jmeter | Extract archive jmeter plugins standard
#   command: chdir={{jmeter_base_dir}}/{{ jmeter_name }}  /usr/bin/unzip -o -q {{ jmeter_dir_tmp }}/{{ jmeter_plugins_standard_archive }}
# #  when: jmeter_plugins_standard_download.changed and jmeter_plugins_standard_enabled
#   when: jmeter_plugins_standard_enabled
#   tags: jmeter_setup

# #jmeter plugins extras
# - name: jmeter | Download jmeter plugins extras
#   get_url:
#     url="{{ jmeter_plugins_extras_url }}"
#     dest="{{ jmeter_dir_tmp }}/"
#   register: jmeter_plugins_extras_download
#   when: jmeter_plugins_extras_enabled
#   tags: jmeter_setup

# - name: jmeter | Extract archive jmeter plugins extras
#   command: chdir={{jmeter_base_dir}}/{{ jmeter_name }}  /usr/bin/unzip -o -q {{ jmeter_dir_tmp }}/{{ jmeter_plugins_extras_archive }}
# #  when: jmeter_plugins_extras_download.changed and jmeter_plugins_extras_enabled
#   when: jmeter_plugins_extras_enabled
#   tags: jmeter_setup

# #jmeter plugins extraslibs
# - name: jmeter | Download jmeter plugins extraslibs
#   get_url:
#     url="{{ jmeter_plugins_extraslibs_url }}"
#     dest="{{ jmeter_dir_tmp }}/"
#   register: jmeter_plugins_extraslibs_download
#   when: jmeter_plugins_extraslibs_enabled
#   tags: jmeter_setup

# - name: jmeter | Extract archive jmeter plugins extraslibs
#   command: chdir={{jmeter_base_dir}}/{{ jmeter_name }}  /usr/bin/unzip -o -q {{ jmeter_dir_tmp }}/{{ jmeter_plugins_extraslibs_archive }}
# #  when: jmeter_plugins_extraslibs_download.changed and jmeter_plugins_extraslibs_enabled
#   when: jmeter_plugins_extraslibs_enabled
#   tags: jmeter_setup

# #jmeter plugins webdriver
# - name: jmeter | Download jmeter plugins webdriver
#   get_url:
#     url="{{ jmeter_plugins_webdriver_url }}"
#     dest="{{ jmeter_dir_tmp }}/"
#   register: jmeter_plugins_webdriver_download
#   when: jmeter_plugins_webdriver_enabled
#   tags: jmeter_setup

# - name: jmeter | Extract archive jmeter plugins webdriver
#   command: chdir={{jmeter_base_dir}}/{{ jmeter_name }}  /usr/bin/unzip -o -q {{ jmeter_dir_tmp }}/{{ jmeter_plugins_webdriver_archive }}
# #  when: jmeter_plugins_webdriver_download.changed and jmeter_plugins_webdriver_enabled
#   when: jmeter_plugins_webdriver_enabled
#   tags: jmeter_setup

# #jmeter plugins hadoop
# - name: jmeter | Download jmeter plugins hadoop
#   get_url:
#     url="{{ jmeter_plugins_hadoop_url }}"
#     dest="{{ jmeter_dir_tmp }}/"
#   register: jmeter_plugins_hadoop_download
#   when: jmeter_plugins_hadoop_enabled
#   tags: jmeter_setup

# - name: jmeter | Extract archive jmeter plugins hadoop
#   command: chdir={{jmeter_base_dir}}/{{ jmeter_name }}  /usr/bin/unzip -o -q {{ jmeter_dir_tmp }}/{{ jmeter_plugins_hadoop_archive }}
# #  when: jmeter_plugins_hadoop_download.changed and jmeter_plugins_hadoop_enabled
#   when: jmeter_plugins_hadoop_enabled
#   tags: jmeter_setup

#jmeter serveragent
- name: Create base directory
  file:
    dest="{{jmeter_serveragent_base_dir}}"
    state=directory
    owner="{{jmeter_owner}}"
    group="{{jmeter_group}}"
  become : yes
  tags: jmeter_setup

- name: jmeter | Create base directory for serveragent
  file:
    dest="{{jmeter_serveragent_base_dir}}"
    state=directory
  when: jmeter_serveragent_enabled
  tags: jmeter_setup
  become: yes

- name: Download jmeter serveragent
  get_url:
    url="{{ jmeter_serveragent_url }}"
    dest="{{ jmeter_dir_tmp }}/"
  register: jmeter_serveragent_download
  when: jmeter_serveragent_enabled
  tags: jmeter_setup

- name: Extract archive jmeter server agent
  unarchive:
    copy: no
    src: "{{ jmeter_dir_tmp }}/{{ jmeter_serveragent_archive }}"
    dest: "{{ jmeter_serveragent_base_dir }}"
  when: jmeter_serveragent_download.changed
  tags: jmeter_setup

- name: Add jmeter-agent service
  copy:
    src: jmeter-agent.service
    dest:  /etc/systemd/system/
    mode: 0777
  when: jmeter_serveragent_enabled
  become: yes

- name: Start the jmeter-agent service
  service:
    name: jmeter-agent
    state: restarted
    enabled: yes
  when: jmeter_serveragent_enabled
  become: yes

#- name: jmeter | Ensure Jmeter restarted
#  service: name=jmeter state=restarted
#  when: jmeter_configure.changed

- name: jmeter | Cleanup temporary directory
  file: name={{ tempdir.stdout }} state=absent
  tags: jmeter_setup
  become: yes

# - debug: msg=" jmeter | Start jmeter agent {{jmeter_serveragent_base_dir}}/startAgent.sh"
# - debug: msg=" jmeter | Start jmeter {{jmeter_base_dir}}/{{ jmeter_name }}/bin/jmeter"

